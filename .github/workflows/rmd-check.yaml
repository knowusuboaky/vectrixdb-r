name: Rmd-check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rmd-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::knitr
            any::rmarkdown
          needs: check

      - name: Render README.Rmd
        if: ${{ hashFiles('README.Rmd') != '' }}
        run: rmarkdown::render("README.Rmd", output_format = "github_document", quiet = TRUE)
        shell: Rscript {0}

      - name: Ensure README.md is current
        if: ${{ hashFiles('README.Rmd') != '' }}
        run: git diff --exit-code -- README.md

      - name: Render vignette Rmd files
        run: |
          files <- list.files("vignettes", pattern = "\\.[Rr]md$", full.names = TRUE)
          if (length(files) == 0) {
            message("No vignette Rmd files found.")
            quit(save = "no")
          }
          for (f in files) {
            message("Rendering ", f)
            rmarkdown::render(
              input = f,
              output_dir = tempdir(),
              quiet = TRUE,
              envir = new.env(parent = globalenv())
            )
          }
        shell: Rscript {0}
